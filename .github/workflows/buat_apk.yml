name: Update APK PlayCloud

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Decode keystore
        run: |
          mkdir -p app/build
          echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > app/build/release.keystore

      - name: Build Stable Release APK
        run: ./gradlew assembleStableRelease
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          ALIAS: ${{ secrets.ALIAS }}
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIMKL_CLIENT_ID: ${{ secrets.SIMKL_CLIENT_ID }}
          SIMKL_CLIENT_SECRET: ${{ secrets.SIMKL_CLIENT_SECRET }}

      - name: Copy APK ke path yang diharapkan
        run: |
          mkdir -p app/build/outputs/apk/stable/release
          apk=$(find app/build/outputs/apk/stable -type f -name "*release*.apk" | head -n 1)
          if [ -z "$apk" ]; then
            echo "ERROR: APK release tidak ditemukan!"
            exit 1
          fi
          echo "Menemukan APK: $apk"
          cp "$apk" app/build/outputs/apk/stable/release/app-stable-release.apk

      - name: Upload APK to existing release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const releaseTag = "v1.6.0"; // Release target
            const apkPath = "app/build/outputs/apk/stable/release/app-stable-release.apk";

            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: releaseTag
            });

            // Hapus asset lama kalau ada
            for (const asset of release.data.assets) {
              if (asset.name.endsWith(".apk")) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
              }
            }

            const fs = require("fs");
            const fileContent = fs.readFileSync(apkPath);
            await github.rest.repos.uploadReleaseAsset({
              url: release.data.upload_url,
              headers: {
                "content-type": "application/vnd.android.package-archive",
                "content-length": fileContent.length
              },
              name: "app-stable-release.apk",
              data: fileContent
            });

            console.log("APK berhasil diupdate di release!");