name: Update APK PlayCloud

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-apk:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Setup JDK 17
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # 2.1️⃣ Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      # 3️⃣ Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x gradlew

      # 4️⃣ Decode keystore
      - name: Decode keystore
        run: |
          mkdir -p app
          echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > app/release.keystore

      # 5️⃣ Check keystore
      - name: Check keystore
        run: |
          keytool -list -v -keystore app/release.keystore -alias $ALIAS -storepass $KEY_STORE_PASSWORD -keypass $KEY_PASSWORD
        env:
          ALIAS: ${{ secrets.ALIAS }}
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # 6️⃣ Build Stable Release APK
      - name: Build Stable Release APK
        run: ./gradlew assembleStableRelease
        env:
          ALIAS: ${{ secrets.ALIAS }}
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIMKL_CLIENT_ID: ${{ secrets.SIMKL_CLIENT_ID }}
          SIMKL_CLIENT_SECRET: ${{ secrets.SIMKL_CLIENT_SECRET }}

      # 7️⃣ Copy APK ke final path
      - name: Copy APK ke final path
        run: |
          mkdir -p app/build/outputs/apk/stable/release
          apk=$(find app/build/outputs/apk/stable -type f -name "*release*.apk" | head -n 1)
          if [ -z "$apk" ]; then
            echo "❌ APK tidak ditemukan!"
            exit 1
          fi
          cp "$apk" app/build/outputs/apk/stable/release/app-stable-release.apk

      # 8️⃣ Upload APK ke release
      - name: Upload APK to release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const releaseTag = "v1.6.0";
            const apkPath = "app/build/outputs/apk/stable/release/app-stable-release.apk";

            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: releaseTag
            });

            for (const asset of release.data.assets) {
              if (asset.name.endsWith(".apk")) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
              }
            }

            const fs = require("fs");
            const fileContent = fs.readFileSync(apkPath);
            await github.rest.repos.uploadReleaseAsset({
              url: release.data.upload_url,
              headers: {
                "content-type": "application/vnd.android.package-archive",
                "content-length": fileContent.length
              },
              name: "app-stable-release.apk",
              data: fileContent
            });

            console.log("✅ APK berhasil diupdate!");
