name: Update APK PlayCloud

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Decode keystore
        run: |
          mkdir -p app
          echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > app/release.keystore

      - name: Check keystore
        run: |
          keytool -list -v \
            -keystore app/release.keystore \
            -alias $ALIAS \
            -storepass $KEY_STORE_PASSWORD
        env:
          ALIAS: ${{ secrets.ALIAS }}
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}

      - name: Build Stable Release APK
        run: ./gradlew assembleStableRelease
        env:
          ALIAS: ${{ secrets.ALIAS }}
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          SIMKL_CLIENT_ID: ${{ secrets.SIMKL_CLIENT_ID }}
          SIMKL_CLIENT_SECRET: ${{ secrets.SIMKL_CLIENT_SECRET }}

      - name: Verify APK exists
        run: |
          ls -lh app/build/outputs/apk/stable/release
          test -f app/build/outputs/apk/stable/release/app-stable-release.apk

      - name: Upload APK to release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require("fs");

            const releaseTag = "v1.6.0";
            const apkPath = "app/build/outputs/apk/stable/release/app-stable-release.apk";

            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: releaseTag
            });

            for (const asset of release.data.assets) {
              if (asset.name.endsWith(".apk")) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
              }
            }

            const fileContent = fs.readFileSync(apkPath);

            await github.rest.repos.uploadReleaseAsset({
              url: release.data.upload_url,
              headers: {
                "content-type": "application/vnd.android.package-archive",
                "content-length": fileContent.length
              },
              name: "app-stable-release.apk",
              data: fileContent
            });

            console.log("âœ… APK stable release berhasil di-update");
